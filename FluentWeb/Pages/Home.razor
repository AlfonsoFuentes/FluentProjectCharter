@page "/"

<FluentStack Orientation="Orientation.Vertical" Style="width:100%;height:100%;">

    <FluentStack Orientation=" Orientation.Horizontal">
        <div>
            <FluentButton Id="createproject" IconEnd="@(new Icons.Regular.Size20.Add())" OnClick="AddNew">

            </FluentButton>
            <FluentTooltip Anchor="createproject" HideTooltipOnCursorLeave="true" Position=TooltipPosition.Top Delay=200>Create Project</FluentTooltip>


        </div>
        <FluentSpacer />
        <FluentSearch @bind-Value="@nameFilter"
        Placeholder="Search..." />
    </FluentStack>

    @foreach (var row in FilteredItems)
    {
        <FluentStack Orientation=" Orientation.Vertical" Style="border:solid 1px lightgray;padding:6px; border-radius:5px;">
            <FluentStack Orientation=" Orientation.Horizontal">
                <FluentLabel Typo="Typography.H4" Style="overflow-wrap: break-word;">@row.Name</FluentLabel>
                <FluentSpacer />
                <div>
                    <FluentButton Id="@($"editproject{row.Id}")" IconEnd="@(new Icons.Regular.Size20.Edit())" OnClick="@(()=>Edit(row))">

                    </FluentButton>
                    <FluentTooltip Anchor="@($"editproject{row.Id}")" HideTooltipOnCursorLeave="true" Position=TooltipPosition.Top Delay=200>Edit</FluentTooltip>

                    <FluentButton id="@($"pdfproject{row.Id}")" IconEnd="@(new Icons.Regular.Size20.DocumentPdf())" OnClick="@(()=>Export(row))"></FluentButton>
                    <FluentTooltip Anchor="@($"pdfproject{row.Id}")" HideTooltipOnCursorLeave="true" Position=TooltipPosition.Top Delay=200>Create PDF</FluentTooltip>

                    <FluentButton Id="@($"deleteproject{row.Id}")" IconEnd="@(new Icons.Regular.Size20.Delete())" OnClick="@(()=>Delete(row))">

                    </FluentButton>
                    <FluentTooltip Anchor="@($"deleteproject{row.Id}")" HideTooltipOnCursorLeave="true" Position=TooltipPosition.Top Delay=200>Delete</FluentTooltip>

                    <FluentButton Id="@($"Showproject{row.Id}")" IconEnd="@(new Icons.Regular.Size20.ArrowBidirectionalUpDown())" OnClick="@(()=>Show(row))">

                    </FluentButton>
                    <FluentTooltip Anchor="@($"Showproject{row.Id}")" HideTooltipOnCursorLeave="true" Position=TooltipPosition.Top Delay=200>Show</FluentTooltip>

                </div>
            </FluentStack>
            @if (row.IsNodeOpen)
            {
                <FluentTabs ShowActiveIndicator="false" OnTabChange="HandleOnTabChange" @bind-ActiveTabId=@row.Tab Style="width:100%">
                    <FluentTab Label="High Level Requirements" Id="HighLevel">
                        <Content>
                            <HighLevelRequirementList GetAll="UpdateAll" Parent="@row"></HighLevelRequirementList>
                        </Content>

                    </FluentTab>
                    <FluentTab Label="Stakeholders" Id="Stakeholders">
                        <Content>
                            <StakeHolderInsideProjectList GetAll="UpdateAll" Parent="@row"></StakeHolderInsideProjectList>
                        </Content>

                    </FluentTab>
                    <FluentTab Label="Business cases" Id="Cases">
                        <Content>
                            <BussinesCaseList GetAll="UpdateAll" Parent="@row">

                            </BussinesCaseList>
                        </Content>

                    </FluentTab>
                    <FluentTab Label="Meetings" Id="Meetings">
                        <Content>
                            <MeetingList GetAll="UpdateAll" Parent="@row">

                            </MeetingList>
                        </Content>

                    </FluentTab>
                    <FluentTab Label="Budget Items" Id="Budgetitems">
                        <Content>
                            <ProjectBudgetItemsList GetAll="UpdateAll" Parent="@row">

                            </ProjectBudgetItemsList>
                        </Content>

                    </FluentTab>
                </FluentTabs>

            }
        </FluentStack>
    }

</FluentStack>
<PageTitle>Home</PageTitle>


@code {
    private async Task HandleOnTabChange(FluentTab tab)
    {
        if (App.ProjectList.CurrentProject != null)
        {
            App.ProjectList.CurrentProject.Tab = tab.Id;
            await GenericService.UpdateState(App.ProjectList.CurrentProject);
        }

        StateHasChanged();
    }

    public async Task Show(ProjectResponse response)
    {
        if (App.ProjectList.CurrentProject == null)
        {
            App.ProjectList.CurrentProject = response;
            response.Open();
            await GenericService.UpdateState(response);

        }
        else if (App.ProjectList.CurrentProject.Id == response.Id)
        {
            response.Close();
            App.ProjectList.CurrentProject = null!;
            await GenericService.UpdateState(response);
        }
        else
        {
            App.ProjectList.CurrentProject.Close();
            await GenericService.UpdateState(App.ProjectList.CurrentProject);
            App.ProjectList.CurrentProject = response;
            
            response.Open();
            await GenericService.UpdateState(response);
        }
        
       



    }

}